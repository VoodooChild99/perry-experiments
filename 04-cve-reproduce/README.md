# Perry Firmware Vulnerability Reproduction Experiment
This is the experiment described in Section 6.2 ("Reproducing Firmware Vulnerabilities") of our paper, where we use the STM32F407 hardware model generated by Perry to emulate Zephyr, and reproduce two CVEs. [`zephyr.elf`](./zephyr.elf) is the binary to be emulated, which is built based on Zephyr [commit@77ad017672ff23869e2743528bf90a8cab5c1d05](https://github.com/zephyrproject-rtos/zephyr/tree/77ad017672ff23869e2743528bf90a8cab5c1d05).

## Preparation
1. Your **HOST** machine must be equipped with a Bluetooth. To enable the Bluetooth, execute this on your **HOST** machine:

```shell
sudo systemctl start bluetooth
```

After this, execute `hcitool dev` in the container, the bluetooth is working normally if you see something like this:
```
Devices:
        hci0    xx:xx:xx:xx:xx:xx
```

2. You must finish the experiments in [`03-universality`](../03-universality).

## Running the Experiment
The vulnerability reproducing method is depicted in Figure 4 of our paper.

### Reproducing CVE-2022-1041
The detailed analysis of this vulnerability can be found in this [security adviosry](https://github.com/zephyrproject-rtos/zephyr/security/advisories/GHSA-p449-9hv9-pj38).

**Steps**:

0. Change directory: `cd perry-experiments/04-cve-reproduce`
1. Open 4 shells (shell `A`, `B`, `C` and `D`)
2. Execute `python proxy.py -v` in shell `A` to start the HCI proxy. This will print every transmitted packets on the screen.
3. Execute `QEMU_DIR=/path/to/qemu ./run_zephyr.sh` in shell `B` to emulate `zephyr` with QEMU. The logs generated by `zephyr` will be saved in `zephyr.log`. If you are running within a container, `QEMU_DIR=/root/qemu`.
4. Execute the following commands in shell `C` to attach `gdb` to zephyr:
```shell
arm-none-eabi-gdb zephyr.elf
# attach to QEMU's gdb server
(gdb) target remote localhost:1234
# set a breakpoint at the bug triggering location
(gdb) b pb_adv.c:386
# resume executing zephyr
(gdb) c
```
5. Wait for around 10 seconds, then execute `python exp.py --cve-2022-1041` in shell `D` and wait for the breakpoint in shell `C` to be triggerred

**Expected results:**

The breakpoint is set at [`pb_adv.c:386`](https://github.com/zephyrproject-rtos/zephyr/blob/77ad017672ff23869e2743528bf90a8cab5c1d05/subsys/bluetooth/mesh/pb_adv.c#L386), which looks like this:

```C
	memcpy(XACT_SEG_DATA(seg), buf->data, buf->len);
```
Now if you enter `p seg` in shell `C` (the one runs `gdb`), you should be able to see that the value of the `seg` variable is 4. According to the [security adviosry](https://github.com/zephyrproject-rtos/zephyr/security/advisories/GHSA-p449-9hv9-pj38) listed above, this will trigger out-of-bound write. You can also search the string `"D: len 2, seg_index 4"` in the log file (`zephyr.log`), which is printed [here](https://github.com/zephyrproject-rtos/zephyr/blob/77ad017672ff23869e2743528bf90a8cab5c1d05/subsys/bluetooth/mesh/pb_adv.c#L346), indicating that `seg = 4`;


Please press `Ctrl-C` in shell `A` and `B` to stop HCI proxy and QEMU, and enter `q` in shell `C` to quit `gdb` after this experiment. Please also execute `sudo systemctl restart bluetooth` on the **HOST** machine.

> Note: Sometimes the above steps can fail due to packet loss. Please follow the following instructions to retry the experiments \
a) Be sure to press `Ctrl-C` in shell `A` and `B` to stop HCI proxy and QEMU \
b) Execute `sudo systemctl restart bluetooth` on your **HOST** machine \
c) Try the above steps again \
d) If you still cannot manage to obtain the expected results, try to execute `python proxy.py -v -w [wait time]` in step 2 to use a longer waiting time before sending packets to the emulator (the default wait time is 0.02 second). Or, you can also try to execute `python exp.py --cve-2022-1041 -w [wait time]` in step 5 to use a longer waiting time between sending two payload packets (the default is 3 seconds).


### Reproducing CVE-2022-1042
The detailed analysis of this vulnerability can be found in this [security adviosry](https://github.com/zephyrproject-rtos/zephyr/security/advisories/GHSA-j7v7-w73r-mm5x).

**Steps**:

0. Change directory: `cd perry-experiments/04-cve-reproduce`
1. Open 4 shells (shell `A`, `B`, `C` and `D`)
2. Execute `python proxy.py -v` in shell `A` to start the HCI proxy. This will print every transmitted packets on the screen.
3. Execute `QEMU_DIR=/path/to/qemu ./run_zephyr.sh` in shell `B` to emulate `zephyr` with QEMU. The logs generated by `zephyr` will be saved in `zephyr.log`. If you are running within a container, `QEMU_DIR=/root/qemu`.
4. Execute the following commands in shell `C` to attach `gdb` to zephyr:
```shell
arm-none-eabi-gdb zephyr.elf
# attach to QEMU's gdb server
(gdb) target remote localhost:1234
# set a breakpoint at the bug triggering location
(gdb) b pb_adv.c:386
# resume executing zephyr
(gdb) c
```
5. Wait for around 10 seconds, then execute `python exp.py --cve-2022-1042` in shell `D` and wait for the breakpoint in shell `C` to be triggerred

**Expected results:**

The breakpoint is set at [`pb_adv.c:386`](https://github.com/zephyrproject-rtos/zephyr/blob/77ad017672ff23869e2743528bf90a8cab5c1d05/subsys/bluetooth/mesh/pb_adv.c#L386), which looks like this:

```C
	memcpy(XACT_SEG_DATA(seg), buf->data, buf->len);
```
Now if you enter `p seg` in shell `C` (the one runs `gdb`), you should be able to see that the value of the `seg` variable is 4. According to the [security adviosry](https://github.com/zephyrproject-rtos/zephyr/security/advisories/GHSA-j7v7-w73r-mm5x) listed above, this will trigger out-of-bound write. You can also search the string `"D: len 2, seg_index 4"` in the log file (`zephyr.log`), which is printed [here](https://github.com/zephyrproject-rtos/zephyr/blob/77ad017672ff23869e2743528bf90a8cab5c1d05/subsys/bluetooth/mesh/pb_adv.c#L346), indicating that `seg = 4`;

> Note: Sometimes the above steps can fail due to packet loss. Please refer to the steps in the previous section for solutions.