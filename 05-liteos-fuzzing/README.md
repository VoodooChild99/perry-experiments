# Perry LiteOS Fuzzing Experiment

In this experiment we use `AFL` to fuzz `LiteOS` with hardware models generated by `Perry`. The directories [`in_json`](./in_json/) and [`in_rand`](./in_rand/) contain the used seeds. The directories `lwm2m_*` and `mqtt_*` contain the compiled fuzz targets listed in Table 6. Each target is fuzzed once for 6 hours.

## Preparation
You must finish the experiments in [`01-efficiency`](../01-efficiency/) to generate hardware models.

## Running the experiment
1. Prepare the **HOST** machine for fuzzing. Please note that the following commands should be executed on the **HOST** machine:
```shell
wget https://raw.githubusercontent.com/AFLplusplus/AFLplusplus/stable/afl-system-config
chmod +x afl-system-config
sudo ./afl-system-config
```

3. Patch QEMU to integrate `stm32f769` models generated by `Perry` and rebuild QEMU. If you are running within a container, `FUZZ_QEMU_DIR=/root/qemu-system-fuzzing PERRY_OUTPUT_DIR=/root/perry-experiments/01-efficiency/exp-1`.
```shell
FUZZ_QEMU_DIR=/path/to/qemu-system-fuzzing PERRY_OUTPUT_DIR=/path/to/perry/output_directory ./prepare_qemu_fuzz.sh
```

4. Run the fuzzing experiment. Note that the runner script will try to leverage every CPU on the machine. If you are running within a container, `AFL_PATH=/root/AFL QEMU_PATH=/root/qemu-system-fuzzing`.
```shell
AFL_PATH=/path/to/AFL QEMU_PATH=/path/to/qemu-system-fuzzing python run.py
```

## Expected Results
The fuzzer will output its result into the `out0` directory under the directory of each target (e.g., `mqtt_ack/out0`). You can check `out0/fuzzer_stats` to get the execution speed (`execs_per_sec`), the total number of executions (`execs_done`), the number of paths (`paths_total`), the number of crashes (`unique_crashes`) and the number of hangs (`unique_hangs`). These numbers should be comparable with those listed in Table 6