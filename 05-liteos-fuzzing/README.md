# Perry LiteOS Fuzzing Experiment
This is the experiment described in Section 6.2 ("Fuzzing RTOS for Vulnerabilities") of our paper, where we use `AFL` to fuzz `LiteOS` with hardware models generated by `Perry`. The directories [`in_json`](./in_json/) and [`in_rand`](./in_rand/) contain the used seeds. The directories `lwm2m_*` and `mqtt_*` contain the compiled fuzz targets listed in Table 6. Each target is fuzzed once for 6 hours.

## Preparation
You must finish the experiments in [`01-efficiency`](../01-efficiency/) to generate hardware models.

## Running the experiment
0. Change directory:
```shell
cd perry-experiments/05-liteos-fuzzing
```

1. Prepare the **HOST** machine for fuzzing. Please note that the following commands should be executed on the **HOST** machine:
```shell
wget https://raw.githubusercontent.com/AFLplusplus/AFLplusplus/stable/afl-system-config
chmod +x afl-system-config
sudo ./afl-system-config
```

3. Patch QEMU to integrate `stm32f769` models generated by `Perry` and rebuild QEMU. If you are running within a container, `FUZZ_QEMU_DIR=/root/qemu-system-fuzzing PERRY_OUTPUT_DIR=/root/perry-experiments/01-efficiency/exp-1`.
```shell
FUZZ_QEMU_DIR=/path/to/qemu-system-fuzzing PERRY_OUTPUT_DIR=/path/to/perry/output_directory ./prepare_qemu_fuzz.sh
```

4. Run the fuzzing experiment. Note that the runner script will try to leverage every CPU on the machine. If you are running within a container, `AFL_PATH=/root/AFL QEMU_PATH=/root/qemu-system-fuzzing`.
```shell
AFL_PATH=/path/to/AFL QEMU_PATH=/path/to/qemu-system-fuzzing python run.py
```

## Expected Results
The results are stored in `result.csv`, and the numbers should be comparable with those listed in Talbe 6 of the paper. Here are the explanations of the numbers listed in `result.csv`:
* **target**: the fuzzed target
* **speed**: the number of fuzzing executions per second
* **execs**: the total number of fuzzing executions
* **paths**: the total number of paths explored during fuzzing
* **crashes**: the total number of crashes triggered during fuzzing
* **hangs**: the total number of hangs triggered during fuzzing
