# Fuzz LiteOS

In this experiment we fuzz `LiteOS` with hardware models generated by `Perry`.

## Running the experiment
1. If you are using the provided Docker environment, directly go to step 2. Otherwise, please first setup [AFL](https://github.com/google/AFL) and our provided [qemu-system-fuzzing](https://github.com/VoodooChild99/qemu-system-fuzzing.git) designed for fuzzing. Please place `AFL` and `qemu-system-fuzzing` under the same directory.
```shell
# AFL
git clone https://github.com/google/AFL.git
cd AFL && make -j$(nproc)

# qemu-system-fuzzing
git clone https://github.com/VoodooChild99/qemu-system-fuzzing.git
cd qemu-system-fuzzing
chmod +x ./qemu-config.sh
./qemu-config.sh
cd build && make -j$(nproc)

# The directory should look like this:
# |-- some parent directory
# | |-- AFL
# | |-- qemu-system-fuzzing
```

2. Prepare the machine for fuzzing. Please note that the following commands should be executed on the **HOST** machine
```shell
wget https://raw.githubusercontent.com/AFLplusplus/AFLplusplus/stable/afl-system-config
chmod +x afl-system-config
sudo ./afl-system-config
```

3. Patch QEMU to integrate `stm32f769` models generated by `Perry` and rebuild QEMU.
```shell
chmod +x ./prepare_qemu_fuzz.sh
FUZZ_QEMU_DIR=/path/to/qemu-system-fuzzing PERRY_OUTPUT_DIR=/path/to/perry/output_directory ./prepare_qemu_fuzz.sh
cd /path/to/qemu-system-fuzzing/build && make -j$(nproc)
```

4. Run the fuzzing experiment. Note that the runner script will try to leverage every CPU on the machine
```shell
AFL_PATH=/path/to/AFL QEMU_PATH=/path/to/qemu-system-fuzzing python run.py
```

5. The results can be found under `targets/out*`